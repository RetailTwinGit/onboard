<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Set Up Your AI Content Engine â€” Retail Twin Labs</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: #0B0F1A;
      --surface: #141925;
      --surface-2: #1C2333;
      --surface-3: #242B3D;
      --text: #E8ECF4;
      --text-muted: #8A94A6;
      --accent: #C4956A;
      --accent-light: #D4A87A;
      --blue: #4A90D9;
      --teal: #0D9488;
      --green: #22C55E;
      --red: #EF4444;
      --yellow: #EAB308;
      --font: 'Inter', -apple-system, sans-serif;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { min-height: 100vh; }

    body {
      background: var(--bg);
      font-family: var(--font);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
    }

    .wizard {
      width: 100%;
      max-width: 720px;
    }

    .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 40px;
    }

    .logo img { height: 32px; }

    .step { display: none; }
    .step.active { display: block; }

    h1 { font-size: 36px; font-weight: 800; letter-spacing: -1px; margin-bottom: 8px; text-align: center; }
    h2 { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 8px; }

    .subtitle { font-size: 16px; color: var(--text-muted); text-align: center; margin-bottom: 32px; line-height: 1.5; }
    .highlight { color: var(--accent); }

    /* â”€â”€ Forms â”€â”€ */
    .form-group { margin-bottom: 20px; }

    label {
      display: block;
      font-size: 13px; font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    input[type="text"], input[type="url"], input[type="email"], textarea, select {
      width: 100%;
      background: var(--surface);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 14px 16px;
      font-family: var(--font);
      font-size: 15px;
      color: var(--text);
      outline: none;
      transition: border-color 0.2s;
    }

    input:focus, textarea:focus, select:focus {
      border-color: var(--accent);
    }

    textarea { resize: vertical; min-height: 60px; }

    select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238A94A6' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 16px center; }

    select option { background: var(--surface); color: var(--text); }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 14px 28px;
      border: none;
      border-radius: 10px;
      font-family: var(--font);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--accent);
      color: #0B0F1A;
      width: 100%;
      justify-content: center;
    }

    .btn-primary:hover { background: var(--accent-light); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-secondary {
      background: var(--surface-2);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.08);
    }

    .btn-secondary:hover { border-color: var(--accent); }

    .btn-row { display: flex; gap: 12px; margin-top: 24px; }
    .btn-row .btn { flex: 1; justify-content: center; }

    .divider {
      display: flex; align-items: center; gap: 12px;
      margin: 20px 0;
      font-size: 12px; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 2px;
    }

    .divider::before, .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: rgba(255,255,255,0.06);
    }

    /* â”€â”€ Loading â”€â”€ */
    .loading { text-align: center; padding: 60px 0; }

    .spinner {
      width: 40px; height: 40px;
      border: 3px solid var(--surface-2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-text { font-size: 15px; color: var(--text-muted); line-height: 1.8; }
    .loading-step { color: var(--accent); font-weight: 600; }

    /* â”€â”€ Profile Cards â”€â”€ */
    .profile-header {
      display: flex; align-items: center; gap: 16px;
      margin-bottom: 24px;
    }

    .profile-avatar {
      width: 64px; height: 64px;
      border-radius: 50%;
      background: var(--surface-2);
      border: 2px solid var(--accent);
      display: flex; align-items: center; justify-content: center;
      font-size: 24px; font-weight: 800;
      color: var(--accent);
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }

    .profile-avatar img {
      width: 100%; height: 100%;
      object-fit: cover;
    }

    .profile-avatar:hover::after {
      content: '\1F4F7';
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .profile-name { font-size: 24px; font-weight: 700; }
    .profile-archetype { font-size: 14px; color: var(--accent); font-weight: 500; }

    .card {
      background: var(--surface);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 11px; font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    /* â”€â”€ Chips â”€â”€ */
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }

    .chip {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid rgba(255,255,255,0.08);
      background: var(--surface-2);
      color: var(--text-muted);
    }

    .chip.selected {
      background: var(--accent);
      color: #0B0F1A;
      border-color: var(--accent);
    }

    /* â”€â”€ Sliders â”€â”€ */
    .slider-row {
      display: flex; align-items: center; gap: 12px;
      margin-bottom: 12px;
    }

    .slider-label { width: 100px; font-size: 13px; font-weight: 500; flex-shrink: 0; }
    .slider-value { width: 28px; text-align: center; font-size: 14px; font-weight: 700; color: var(--accent); }

    input[type="range"] {
      flex: 1;
      -webkit-appearance: none;
      height: 4px;
      border-radius: 2px;
      background: var(--surface-3);
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px; height: 18px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
    }

    /* â”€â”€ Color Pickers â”€â”€ */
    .color-row { display: flex; gap: 12px; align-items: center; }

    .color-picker-wrap {
      display: flex; align-items: center; gap: 8px;
      background: var(--surface-2);
      border-radius: 8px;
      padding: 6px 10px;
    }

    input[type="color"] {
      width: 28px; height: 28px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: none;
      padding: 0;
    }

    .color-hex { font-size: 12px; color: var(--text-muted); font-family: monospace; }

    /* â”€â”€ Toggle â”€â”€ */
    .toggle-section {
      cursor: pointer;
      padding: 12px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-top: 1px solid rgba(255,255,255,0.06);
      margin-top: 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
    }

    .toggle-section:hover { color: var(--text); }
    .toggle-arrow { transition: transform 0.2s; }
    .toggle-arrow.open { transform: rotate(180deg); }
    .toggle-content { display: none; padding-top: 16px; }
    .toggle-content.open { display: block; }

    /* â”€â”€ Draft Preview â”€â”€ */
    .draft-preview {
      background: var(--surface);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
      overflow: hidden;
    }

    .draft-header {
      padding: 16px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      display: flex; align-items: center; gap: 12px;
    }

    .draft-brand-dot {
      width: 12px; height: 12px;
      border-radius: 50%;
    }

    .draft-brand-name { font-size: 13px; font-weight: 600; }
    .draft-tagline { font-size: 12px; color: var(--text-muted); margin-left: auto; }

    .draft-body {
      padding: 24px;
      font-size: 15px;
      line-height: 1.8;
      color: var(--text);
      white-space: pre-wrap;
    }

    .draft-body h1, .draft-body h2, .draft-body h3 {
      margin: 16px 0 8px;
      line-height: 1.3;
    }

    .draft-footer {
      padding: 16px 24px;
      border-top: 1px solid rgba(255,255,255,0.06);
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.6;
    }

    .draft-meta {
      display: flex; gap: 20px;
      margin-top: 16px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .draft-meta span { display: flex; align-items: center; gap: 4px; }

    /* â”€â”€ Badges â”€â”€ */
    .success-badge {
      display: inline-flex; align-items: center; gap: 8px;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      color: var(--green);
      font-weight: 500;
      margin-bottom: 20px;
    }

    .pending-badge {
      display: flex; align-items: flex-start; gap: 10px;
      background: rgba(234, 179, 8, 0.08);
      border: 1px solid rgba(234, 179, 8, 0.2);
      border-radius: 10px;
      padding: 14px 18px;
      font-size: 14px;
      color: var(--yellow);
      font-weight: 500;
      margin-top: 20px;
      line-height: 1.5;
    }

    .pending-badge .icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }

    .error-msg {
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.2);
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 14px;
      color: var(--red);
      margin-top: 12px;
    }

    /* â”€â”€ Progress Steps â”€â”€ */
    .progress-bar {
      display: flex; justify-content: center; gap: 8px;
      margin-bottom: 32px;
    }

    .progress-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: var(--surface-3);
      transition: all 0.3s;
    }

    .progress-dot.active { background: var(--accent); width: 32px; border-radius: 5px; }
    .progress-dot.done { background: var(--green); }

    /* â”€â”€ Email verification â”€â”€ */
    .email-icon {
      width: 64px; height: 64px;
      border-radius: 50%;
      background: rgba(196, 149, 106, 0.1);
      border: 2px solid var(--accent);
      display: flex; align-items: center; justify-content: center;
      font-size: 28px;
      margin: 0 auto 24px;
    }

    .resend-link {
      color: var(--accent);
      cursor: pointer;
      text-decoration: underline;
      font-weight: 500;
    }

    .resend-link:hover { color: var(--accent-light); }
  </style>
</head>
<body>

<div class="wizard">
  <div class="logo">
    <img src="https://sbmddzbsnparskpitrdz.supabase.co/storage/v1/object/public/brand-assets/retail-twin-labs-logo.svg" alt="Retail Twin Labs">
  </div>

  <div class="progress-bar">
    <div class="progress-dot active" id="dot1"></div>
    <div class="progress-dot" id="dot2"></div>
    <div class="progress-dot" id="dot3"></div>
    <div class="progress-dot" id="dot4"></div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STEP 1: INPUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="step active" id="step1">
    <h1>Set up your <span class="highlight">AI content engine</span></h1>
    <p class="subtitle">Tell us about your company. We'll build your voice profile in under 30 seconds.</p>

    <div class="form-group">
      <label>Company Name *</label>
      <input type="text" id="companyName" placeholder="e.g. Archie" autofocus>
    </div>

    <div class="form-group">
      <label>Website URL</label>
      <input type="url" id="websiteUrl" placeholder="e.g. https://retailtwin.com">
    </div>

    <div class="form-group">
      <label>What does your company do? <span style="opacity:0.5">(optional)</span></label>
      <textarea id="description" rows="2" placeholder="e.g. Supply Twin Merchant at Retail Twin Labs"></textarea>
    </div>

    <div class="divider">or clone from existing</div>

    <div class="form-group">
      <label>Start from an existing voice profile</label>
      <select id="cloneFrom">
        <option value="">â€” Fresh start (AI builds everything) â€”</option>
      </select>
    </div>

    <button class="btn btn-primary" id="btnAnalyze" onclick="startOnboarding()">
      Build My Voice â†’
    </button>

    <div id="step1Error"></div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STEP 1B: LOADING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="step" id="step1Loading">
    <div class="loading">
      <div class="spinner"></div>
      <div class="loading-text" id="loadingText">
        <div class="loading-step">Analyzing website...</div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STEP 2: VOICE PROFILE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="step" id="step2">
    <div class="success-badge">âœ“ Your voice profile is ready</div>

    <div class="profile-header">
      <div class="profile-avatar" id="avatarWrap" onclick="document.getElementById('logoUpload').click()">
        <span id="avatarInitial"></span>
        <input type="file" id="logoUpload" accept="image/*" style="display:none" onchange="handleLogoUpload(event)">
      </div>
      <div>
        <div class="profile-name" id="profileName"></div>
        <div class="profile-archetype" id="profileArchetype"></div>
      </div>
    </div>

    <!-- Voice Archetype -->
    <div class="card">
      <div class="card-title">Voice Archetype</div>
      <select id="editArchetype" onchange="updateArchetypeDesc()">
        <option value="thought_leader">Thought Leader</option>
        <option value="trusted_authority">Trusted Authority</option>
        <option value="expert_advisor">Expert Advisor</option>
        <option value="industry_insider">Industry Insider</option>
        <option value="provocateur">Provocateur</option>
        <option value="educator">Educator</option>
      </select>
      <p style="font-size:13px; color:var(--text-muted); margin-top:8px; line-height:1.5" id="archetypeDesc"></p>
    </div>

    <!-- Audience -->
    <div class="card">
      <div class="card-title">Audience</div>
      <input type="text" id="editAudience">
    </div>

    <!-- Topics -->
    <div class="card">
      <div class="card-title">Topics</div>
      <div class="chips" id="topicChips"></div>
    </div>

    <!-- Industries -->
    <div class="card">
      <div class="card-title">Industries</div>
      <div class="chips" id="industryChips"></div>
    </div>

    <!-- Brand Colors -->
    <div class="card">
      <div class="card-title">Brand Colors</div>
      <div class="color-row">
        <div class="color-picker-wrap">
          <input type="color" id="editPrimaryColor" onchange="document.getElementById('primaryHex').textContent=this.value">
          <span class="color-hex" id="primaryHex"></span>
        </div>
        <div class="color-picker-wrap">
          <input type="color" id="editAccentColor" onchange="document.getElementById('accentHex').textContent=this.value">
          <span class="color-hex" id="accentHex"></span>
        </div>
      </div>
    </div>

    <!-- Tagline -->
    <div class="card">
      <div class="card-title">Content Tagline</div>
      <input type="text" id="editTagline" placeholder="e.g. What Archie sees coming">
    </div>

    <!-- Fine-tune toggle -->
    <div class="toggle-section" onclick="toggleFineTune()">
      <span>Fine-tune your voice</span>
      <span class="toggle-arrow" id="fineTuneArrow">â–¾</span>
    </div>

    <div class="toggle-content" id="fineTuneSection">
      <!-- Tone Sliders -->
      <div class="card">
        <div class="card-title">Tone Sliders</div>
        <div class="slider-row">
          <span class="slider-label">Formality</span>
          <input type="range" min="0" max="10" id="sliderFormality" oninput="document.getElementById('valFormality').textContent=this.value">
          <span class="slider-value" id="valFormality">5</span>
        </div>
        <div class="slider-row">
          <span class="slider-label">Energy</span>
          <input type="range" min="0" max="10" id="sliderEnergy" oninput="document.getElementById('valEnergy').textContent=this.value">
          <span class="slider-value" id="valEnergy">5</span>
        </div>
        <div class="slider-row">
          <span class="slider-label">Humor</span>
          <input type="range" min="0" max="10" id="sliderHumor" oninput="document.getElementById('valHumor').textContent=this.value">
          <span class="slider-value" id="valHumor">3</span>
        </div>
        <div class="slider-row">
          <span class="slider-label">Complexity</span>
          <input type="range" min="0" max="10" id="sliderComplexity" oninput="document.getElementById('valComplexity').textContent=this.value">
          <span class="slider-value" id="valComplexity">5</span>
        </div>
      </div>

      <!-- Messaging Principles -->
      <div class="card">
        <div class="card-title">Messaging Principles</div>
        <div id="principlesList"></div>
      </div>

      <!-- Content Mix -->
      <div class="card">
        <div class="card-title">Content Mix</div>
        <div class="slider-row">
          <span class="slider-label">Educational</span>
          <input type="range" min="0" max="100" id="mixEdu" oninput="document.getElementById('valMixEdu').textContent=this.value+'%'">
          <span class="slider-value" id="valMixEdu">40%</span>
        </div>
        <div class="slider-row">
          <span class="slider-label">Promotional</span>
          <input type="range" min="0" max="100" id="mixPromo" oninput="document.getElementById('valMixPromo').textContent=this.value+'%'">
          <span class="slider-value" id="valMixPromo">25%</span>
        </div>
        <div class="slider-row">
          <span class="slider-label">Engagement</span>
          <input type="range" min="0" max="100" id="mixEngage" oninput="document.getElementById('valMixEngage').textContent=this.value+'%'">
          <span class="slider-value" id="valMixEngage">25%</span>
        </div>
        <div class="slider-row">
          <span class="slider-label">Entertainment</span>
          <input type="range" min="0" max="100" id="mixEntertain" oninput="document.getElementById('valMixEntertain').textContent=this.value+'%'">
          <span class="slider-value" id="valMixEntertain">10%</span>
        </div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-secondary" onclick="saveProfile()">Save Profile</button>
      <button class="btn btn-primary" onclick="proceedToEmail()">Continue â†’</button>
    </div>

    <div id="step2Error"></div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STEP 2.5: EMAIL VERIFICATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="step" id="stepEmail">
    <h1>Almost there</h1>
    <p class="subtitle">Enter your email to secure your voice profile and get your first AI-generated draft.</p>

    <div class="form-group">
      <label>Email Address *</label>
      <input type="email" id="userEmail" placeholder="e.g. archie@retailtwin.com">
    </div>

    <button class="btn btn-primary" onclick="sendMagicLink()">
      Send me a magic link â†’
    </button>

    <div id="emailError"></div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STEP 2.5B: CHECK EMAIL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="step" id="stepEmailSent">
    <div style="text-align:center">
      <div class="email-icon">âœ‰ï¸</div>
      <h1>Check your email</h1>
      <p class="subtitle">
        We sent a magic link to <strong id="sentEmailDisplay"></strong>.<br>
        Click the link to verify and generate your first draft.
      </p>
      <p style="font-size:13px; color:var(--text-muted); margin-top:24px">
        Didn't receive it? <span class="resend-link" onclick="resendMagicLink()">Resend magic link</span>
      </p>
      <div id="resendMsg"></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STEP 3A: GENERATING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="step" id="step3Loading">
    <div class="loading">
      <div class="spinner"></div>
      <div class="loading-text">
        <div class="loading-step">Selecting the most relevant articles...</div>
        <div style="margin-top:4px; color:var(--text-muted)">Generating your first thought leadership draft</div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STEP 3: FIRST DRAFT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="step" id="step3">
    <div class="success-badge">âœ“ Your first draft is ready</div>

    <div class="draft-preview">
      <div class="draft-header">
        <div class="draft-brand-dot" id="draftBrandDot"></div>
        <div class="draft-brand-name" id="draftBrandName"></div>
        <div class="draft-tagline" id="draftTagline"></div>
      </div>
      <div class="draft-body" id="draftBody"></div>
      <div class="draft-footer" id="draftFooter"></div>
    </div>

    <div class="draft-meta" id="draftMeta"></div>

    <div class="pending-badge">
      <span class="icon">â³</span>
      <div>
        <strong>Your profile is pending approval.</strong><br>
        You'll receive an email at <strong id="pendingEmail"></strong> once your account is activated.
        After that, you can manage your drafts and generate more content from the review dashboard.
      </div>
    </div>
  </div>
</div>

<script>
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Config
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const SUPABASE_URL = 'https://sbmddzbsnparskpitrdz.supabase.co';
  const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNibWRkemJzbnBhcnNrcGl0cmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMjQ0MDMsImV4cCI6MjA4NzYwMDQwM30.caIkPkIUSVFDKp-KMv1Gao1-yvdfmtoplh-9CQzlDTs';

  // Supabase JS client for auth
  const sbClient = supabase.createClient(SUPABASE_URL, ANON_KEY);

  const ARCHETYPE_DESC = {
    thought_leader: 'Conversational yet authoritative, connecting dots others miss',
    trusted_authority: 'Direct, clear-eyed, commercially grounded',
    expert_advisor: 'Measured and authoritative, translating complexity into clarity',
    industry_insider: 'Well-connected, blending anecdote with analysis',
    provocateur: 'Contrarian, challenging conventional thinking',
    educator: 'Patient, structured, building understanding step by step',
  };

  const ALL_TOPICS = [
    'inventory_intelligence', 'demand_planning', 'supply_chain_disruption',
    'sourcing_manufacturing', 'logistics_transport', 'market_shift',
    'regulatory_change', 'technology_innovation', 'sustainability',
    'geopolitical', 'mergers_acquisitions', 'earnings_results',
    'consumer_trends', 'workforce'
  ];

  const ALL_INDUSTRIES = [
    'footwear', 'apparel', 'accessories', 'retail', 'logistics',
    'fashion', 'luxury', 'sportswear', 'outdoor', 'wholesale'
  ];

  let brandData = null;
  let userEmail = null;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Init: Load existing brands for clone dropdown (only active ones)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadExistingBrands() {
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/brand_profiles?select=id,display_name&onboarding_status=eq.active&order=display_name`, {
        headers: {
          'apikey': ANON_KEY,
          'Authorization': `Bearer ${ANON_KEY}`,
          'Accept-Profile': 'news',
        }
      });
      const brands = await res.json();
      const sel = document.getElementById('cloneFrom');
      brands.forEach(b => {
        const opt = document.createElement('option');
        opt.value = b.id;
        opt.textContent = b.display_name;
        sel.appendChild(opt);
      });
    } catch (e) {
      console.log('Could not load brands:', e);
    }
  }

  loadExistingBrands();

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Step transitions (4 dots now)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showStep(id) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');

    // Map step IDs to progress dot numbers
    let stepNum;
    if (id === 'step1' || id === 'step1Loading') stepNum = 1;
    else if (id === 'step2') stepNum = 2;
    else if (id === 'stepEmail' || id === 'stepEmailSent') stepNum = 3;
    else stepNum = 4; // step3Loading, step3

    ['dot1','dot2','dot3','dot4'].forEach((d, i) => {
      const el = document.getElementById(d);
      el.className = 'progress-dot';
      if (i + 1 < stepNum) el.classList.add('done');
      if (i + 1 === stepNum) el.classList.add('active');
    });
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Step 1: Start onboarding
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function startOnboarding() {
    const name = document.getElementById('companyName').value.trim();
    if (!name) {
      document.getElementById('step1Error').innerHTML = '<div class="error-msg">Please enter a company name.</div>';
      return;
    }

    document.getElementById('step1Error').innerHTML = '';
    showStep('step1Loading');

    // Animated loading text
    const loadingEl = document.getElementById('loadingText');
    const steps = [
      'Analyzing website...',
      'Inferring brand voice...',
      'Building content profile...',
      'Configuring news sources...',
    ];
    let stepIdx = 0;
    const loadingInterval = setInterval(() => {
      stepIdx = Math.min(stepIdx + 1, steps.length - 1);
      loadingEl.innerHTML = `<div class="loading-step">${steps[stepIdx]}</div>`;
    }, 4000);

    try {
      const payload = {
        company_name: name,
        website_url: document.getElementById('websiteUrl').value.trim() || undefined,
        description: document.getElementById('description').value.trim() || undefined,
        clone_from_brand_id: document.getElementById('cloneFrom').value || undefined,
      };

      const res = await fetch(`${SUPABASE_URL}/functions/v1/news-onboard-brand`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${ANON_KEY}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
      });

      const data = await res.json();
      clearInterval(loadingInterval);

      if (!data.success) throw new Error(data.error);

      brandData = data.brand;
      populateStep2(data);
      showStep('step2');
    } catch (e) {
      clearInterval(loadingInterval);
      showStep('step1');
      document.getElementById('step1Error').innerHTML = `<div class="error-msg">${e.message}</div>`;
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Step 2: Populate profile editor
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function populateStep2(data) {
    const b = data.brand;

    // Header
    document.getElementById('profileName').textContent = b.display_name;
    document.getElementById('avatarInitial').textContent = b.display_name.charAt(0).toUpperCase();
    updateArchetypeDisplay(b.voice_archetype);

    // Fields
    document.getElementById('editArchetype').value = b.voice_archetype;
    document.getElementById('editAudience').value = b.primary_audience || '';
    document.getElementById('editTagline').value = b.content_tagline || '';

    // Colors
    document.getElementById('editPrimaryColor').value = b.primary_color || '#1E3A5F';
    document.getElementById('editAccentColor').value = b.accent_color || '#C4956A';
    document.getElementById('primaryHex').textContent = b.primary_color || '#1E3A5F';
    document.getElementById('accentHex').textContent = b.accent_color || '#C4956A';

    // Sliders
    document.getElementById('sliderFormality').value = b.formality_level;
    document.getElementById('valFormality').textContent = b.formality_level;
    document.getElementById('sliderEnergy').value = b.energy_level;
    document.getElementById('valEnergy').textContent = b.energy_level;
    document.getElementById('sliderHumor').value = b.humor_level;
    document.getElementById('valHumor').textContent = b.humor_level;
    document.getElementById('sliderComplexity').value = b.complexity_level;
    document.getElementById('valComplexity').textContent = b.complexity_level;

    // Content Mix
    document.getElementById('mixEdu').value = b.content_mix_educational;
    document.getElementById('valMixEdu').textContent = b.content_mix_educational + '%';
    document.getElementById('mixPromo').value = b.content_mix_promotional;
    document.getElementById('valMixPromo').textContent = b.content_mix_promotional + '%';
    document.getElementById('mixEngage').value = b.content_mix_engagement;
    document.getElementById('valMixEngage').textContent = b.content_mix_engagement + '%';
    document.getElementById('mixEntertain').value = b.content_mix_entertainment;
    document.getElementById('valMixEntertain').textContent = b.content_mix_entertainment + '%';

    // Topics
    renderChips('topicChips', ALL_TOPICS, b.relevant_topics || []);
    renderChips('industryChips', ALL_INDUSTRIES, b.relevant_industries || []);

    // Messaging Principles
    renderPrinciples(b.key_messaging_principles || []);
  }

  function renderChips(containerId, allItems, selectedItems) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    allItems.forEach(item => {
      const chip = document.createElement('div');
      chip.className = 'chip' + (selectedItems.includes(item) ? ' selected' : '');
      chip.textContent = item.replace(/_/g, ' ');
      chip.dataset.value = item;
      chip.onclick = () => chip.classList.toggle('selected');
      container.appendChild(chip);
    });
  }

  function renderPrinciples(principles) {
    const container = document.getElementById('principlesList');
    container.innerHTML = '';
    principles.forEach((p, i) => {
      const div = document.createElement('div');
      div.style.cssText = 'margin-bottom:8px';
      div.innerHTML = `<input type="text" value="${p.replace(/"/g, '&quot;')}" class="principle-input" style="font-size:13px; padding:10px 12px">`;
      container.appendChild(div);
    });
  }

  function updateArchetypeDesc() {
    const val = document.getElementById('editArchetype').value;
    updateArchetypeDisplay(val);
  }

  function updateArchetypeDisplay(archetype) {
    document.getElementById('profileArchetype').textContent =
      archetype.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    document.getElementById('archetypeDesc').textContent = ARCHETYPE_DESC[archetype] || '';
  }

  function toggleFineTune() {
    const section = document.getElementById('fineTuneSection');
    const arrow = document.getElementById('fineTuneArrow');
    section.classList.toggle('open');
    arrow.classList.toggle('open');
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Logo Upload
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function handleLogoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Show preview immediately
    const reader = new FileReader();
    reader.onload = (e) => {
      const wrap = document.getElementById('avatarWrap');
      wrap.innerHTML = `<img src="${e.target.result}"><input type="file" id="logoUpload" accept="image/*" style="display:none" onchange="handleLogoUpload(event)">`;
    };
    reader.readAsDataURL(file);

    // Upload via edge function
    const base64Reader = new FileReader();
    base64Reader.onload = async (e) => {
      const base64 = e.target.result.split(',')[1];
      try {
        await fetch(`${SUPABASE_URL}/functions/v1/news-update-brand`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${ANON_KEY}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            brand_id: brandData.id,
            updates: {},
            logo_file: base64,
            logo_filename: file.name,
          }),
        });
      } catch (e) {
        console.error('Logo upload failed:', e);
      }
    };
    base64Reader.readAsDataURL(file);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Collect profile updates
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function collectUpdates() {
    return {
      voice_archetype: document.getElementById('editArchetype').value,
      primary_audience: document.getElementById('editAudience').value,
      content_tagline: document.getElementById('editTagline').value,
      primary_color: document.getElementById('editPrimaryColor').value,
      accent_color: document.getElementById('editAccentColor').value,
      formality_level: parseInt(document.getElementById('sliderFormality').value),
      energy_level: parseInt(document.getElementById('sliderEnergy').value),
      humor_level: parseInt(document.getElementById('sliderHumor').value),
      complexity_level: parseInt(document.getElementById('sliderComplexity').value),
      content_mix_educational: parseInt(document.getElementById('mixEdu').value),
      content_mix_promotional: parseInt(document.getElementById('mixPromo').value),
      content_mix_engagement: parseInt(document.getElementById('mixEngage').value),
      content_mix_entertainment: parseInt(document.getElementById('mixEntertain').value),
      relevant_topics: getSelectedChips('topicChips'),
      relevant_industries: getSelectedChips('industryChips'),
      key_messaging_principles: getPrinciples(),
    };
  }

  async function saveUpdates(updates) {
    const res = await fetch(`${SUPABASE_URL}/functions/v1/news-update-brand`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${ANON_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ brand_id: brandData.id, updates }),
    });
    const data = await res.json();
    if (!data.success) throw new Error(data.error);
    Object.assign(brandData, updates);
    return data;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Step 2: Save Profile (stay on step)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function saveProfile() {
    document.getElementById('step2Error').innerHTML = '';
    try {
      await saveUpdates(collectUpdates());
      document.getElementById('step2Error').innerHTML =
        '<div class="success-badge" style="margin-top:12px">âœ“ Profile saved</div>';
    } catch (e) {
      document.getElementById('step2Error').innerHTML = `<div class="error-msg">${e.message}</div>`;
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Step 2 â†’ 2.5: Save and proceed to email
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function proceedToEmail() {
    document.getElementById('step2Error').innerHTML = '';
    try {
      await saveUpdates(collectUpdates());
      showStep('stepEmail');
    } catch (e) {
      document.getElementById('step2Error').innerHTML = `<div class="error-msg">${e.message}</div>`;
    }
  }

  function getSelectedChips(containerId) {
    return Array.from(document.querySelectorAll(`#${containerId} .chip.selected`))
      .map(c => c.dataset.value);
  }

  function getPrinciples() {
    return Array.from(document.querySelectorAll('.principle-input'))
      .map(input => input.value.trim())
      .filter(Boolean);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Step 2.5: Magic Link
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function sendMagicLink() {
    const email = document.getElementById('userEmail').value.trim();
    if (!email || !email.includes('@')) {
      document.getElementById('emailError').innerHTML = '<div class="error-msg">Please enter a valid email address.</div>';
      return;
    }

    document.getElementById('emailError').innerHTML = '';
    userEmail = email;

    // Update owner_email on the brand
    try {
      await fetch(`${SUPABASE_URL}/functions/v1/news-update-brand`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${ANON_KEY}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          brand_id: brandData.id,
          updates: { owner_email: email },
        }),
      });
    } catch (e) {
      console.log('Could not update owner_email:', e);
    }

    // Send magic link via Supabase Auth
    const currentUrl = new URL(window.location.href);
    currentUrl.search = ''; // clear existing params
    currentUrl.searchParams.set('brand_id', brandData.id);
    currentUrl.searchParams.set('step', 'confirmed');

    const { error } = await sbClient.auth.signInWithOtp({
      email,
      options: {
        emailRedirectTo: currentUrl.toString(),
      },
    });

    if (error) {
      document.getElementById('emailError').innerHTML = `<div class="error-msg">${error.message}</div>`;
      return;
    }

    document.getElementById('sentEmailDisplay').textContent = email;
    showStep('stepEmailSent');
  }

  async function resendMagicLink() {
    if (!userEmail) return;

    const currentUrl = new URL(window.location.href);
    currentUrl.search = '';
    currentUrl.searchParams.set('brand_id', brandData.id);
    currentUrl.searchParams.set('step', 'confirmed');

    const { error } = await sbClient.auth.signInWithOtp({
      email: userEmail,
      options: {
        emailRedirectTo: currentUrl.toString(),
      },
    });

    document.getElementById('resendMsg').innerHTML = error
      ? `<div class="error-msg" style="margin-top:12px">${error.message}</div>`
      : '<div class="success-badge" style="margin-top:12px">âœ“ Magic link resent</div>';
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Magic Link Redirect Handler
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function handleRedirect() {
    const params = new URLSearchParams(window.location.search);
    const brandId = params.get('brand_id');
    const step = params.get('step');

    // Also check for hash-based auth tokens (Supabase PKCE flow)
    const hashParams = new URLSearchParams(window.location.hash.replace('#', ''));

    if (step !== 'confirmed' || !brandId) return false;

    // Wait for auth session to be established
    const { data: { session }, error: sessionError } = await sbClient.auth.getSession();

    if (!session) {
      // Try exchanging the token from URL hash
      const accessToken = hashParams.get('access_token');
      if (accessToken) {
        await sbClient.auth.setSession({
          access_token: accessToken,
          refresh_token: hashParams.get('refresh_token') || '',
        });
      } else {
        console.log('No session found after redirect');
        return false;
      }
    }

    // Get fresh session
    const { data: { session: finalSession } } = await sbClient.auth.getSession();
    if (!finalSession) {
      console.log('Still no session after retry');
      return false;
    }

    userEmail = finalSession.user.email;

    // Show generating state
    showStep('step3Loading');

    // Link user to brand via edge function
    try {
      const linkRes = await fetch(`${SUPABASE_URL}/functions/v1/news-onboard-link-user`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${finalSession.access_token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ brand_id: brandId }),
      });
      const linkData = await linkRes.json();
      if (!linkData.success) console.error('Link user failed:', linkData.error);
    } catch (e) {
      console.error('Link user error:', e);
    }

    // Fetch brand data for display
    try {
      const brandRes = await fetch(
        `${SUPABASE_URL}/rest/v1/brand_profiles?id=eq.${brandId}&select=*`,
        {
          headers: {
            'apikey': ANON_KEY,
            'Authorization': `Bearer ${ANON_KEY}`,
            'Accept-Profile': 'news',
          }
        }
      );
      const brands = await brandRes.json();
      if (brands.length > 0) {
        brandData = brands[0];
      }
    } catch (e) {
      console.error('Failed to fetch brand:', e);
    }

    if (!brandData) {
      showStep('step1');
      return false;
    }

    // Generate first draft
    try {
      const res = await fetch(`${SUPABASE_URL}/functions/v1/news-generate-content`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${ANON_KEY}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          brand_name: brandData.name,
          channel: 'linkedin',
          content_type: 'synthesis',
          min_relevance: 50,
          max_articles: 5,
        }),
      });

      const data = await res.json();
      if (!data.success) throw new Error(data.error);

      populateStep3(data);
      showStep('step3');
    } catch (e) {
      // Even if draft generation fails, show a message
      showStep('step3');
      document.getElementById('draftBody').innerHTML =
        '<p style="color:var(--text-muted)">Draft generation is processing. Check back shortly in the review dashboard.</p>';
    }

    // Clean the URL
    window.history.replaceState({}, '', window.location.pathname);

    return true;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Step 3: Populate draft
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function populateStep3(data) {
    // Brand dot color
    document.getElementById('draftBrandDot').style.background = brandData.primary_color || '#1E3A5F';
    document.getElementById('draftBrandName').textContent = brandData.display_name;
    document.getElementById('draftTagline').textContent = brandData.content_tagline || '';

    // Body
    const content = data.content || '';
    document.getElementById('draftBody').innerHTML = content
      .replace(/^### (.*)/gm, '<h3>$1</h3>')
      .replace(/^## (.*)/gm, '<h2>$1</h2>')
      .replace(/^# (.*)/gm, '<h1>$1</h1>')
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\n\n/g, '<br><br>')
      .replace(/\n/g, '<br>');

    // Footer
    document.getElementById('draftFooter').textContent = brandData.content_footer || '';

    // Pending email
    document.getElementById('pendingEmail').textContent = userEmail || brandData.owner_email || '';

    // Meta
    const d = data.draft;
    if (d) {
      document.getElementById('draftMeta').innerHTML =
        `<span>ğŸ“„ ${d.source_articles} articles</span>` +
        `<span>ğŸ“ ${d.word_count} words</span>` +
        `<span>â± ${d.estimated_read_time_minutes} min read</span>` +
        `<span>ğŸ“¢ ${d.channel}</span>`;
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Enter key support
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      if (document.getElementById('step1').classList.contains('active') && e.target.tagName !== 'TEXTAREA') {
        e.preventDefault();
        startOnboarding();
      } else if (document.getElementById('stepEmail').classList.contains('active')) {
        e.preventDefault();
        sendMagicLink();
      }
    }
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // On page load: check for magic link redirect
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (async function init() {
    const handled = await handleRedirect();
    if (!handled) {
      loadExistingBrands();
    }
  })();
</script>

</body>
</html>
